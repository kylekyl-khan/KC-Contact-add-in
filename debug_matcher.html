<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>é›¢ç·šé…å°è¨ºæ–·å·¥å…·</title>
    <style>
        body { font-family: "Segoe UI", sans-serif; padding: 20px; background: #f4f4f4; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: #333; }
        .success { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
        code { background: #eee; padding: 2px 5px; border-radius: 4px; font-family: monospace; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f8f9fa; }
    </style>
</head>
<body>
    <h1>ğŸ•µï¸â€â™‚ï¸ é›¢ç·šé…å°è¨ºæ–·å·¥å…·</h1>
    <p>æ­¤å·¥å…·æ¨¡æ“¬ taskpane.js çš„é‚è¼¯ï¼Œå”åŠ©æ‰¾å‡ºå­—ä¸²ä¸åŒ¹é…çš„åŸå› ã€‚</p>

    <div class="card">
        <h2>1. è³‡æ–™æ¨¡æ“¬</h2>
        <div id="data-preview"></div>
    </div>

    <div class="card">
        <h2>2. é…å°çµæœåˆ†æ</h2>
        <table id="result-table">
            <thead>
                <tr>
                    <th>ä½¿ç”¨è€…éƒ¨é–€ (Raw)</th>
                    <th>æ¨™æº–åŒ–å¾Œ (User Clean)</th>
                    <th>é æœŸåŒ¹é…ç¾¤çµ„ (Group Clean)</th>
                    <th>çµæœ</th>
                    <th>åŸå› æ¨æ¸¬</th>
                </tr>
            </thead>
            <tbody id="result-body"></tbody>
        </table>
    </div>

    <script>
        // === 1. æ¨¡æ“¬è³‡æ–™ (ä¾†è‡ªä½ çš„ Log) ===
        const mockUsers = [
            { displayName: "é™³å»ºéŠ˜", department: "ç‡Ÿæ¥­äºŒè™•é«˜é›„ç‡Ÿæ¥­éƒ¨åœ‹ä¸­é«˜ä¸€å€" }, // ä½ çš„çœŸå¯¦å¤±æ•—æ¡ˆä¾‹
            { displayName: "æ¸¬è©¦äººå“¡", department: "æ–°ç«¹æ•™å‹™è™•" } // å°ç…§çµ„
        ];

        const mockGroups = [
            { displayName: "KS020901.ç‡Ÿæ¥­äºŒè™•é«˜é›„ç‡Ÿæ¥­éƒ¨åœ‹ä¸­é«˜ä¸€å€" }, // å°æ‡‰çš„ç¾¤çµ„
            { displayName: "KCHC1010.æ–°ç«¹æ•™å‹™è™•" }
        ];

        // === 2. ä½ çš„æ ¸å¿ƒé‚è¼¯ (å¾…æ¸¬è©¦) ===
        
        // ğŸ”¥ é€™è£¡å°±æ˜¯æˆ‘å€‘è¦æ¸¬è©¦çš„ã€Œæ¨™æº–åŒ–å‡½å¼ã€
        // ç›®å‰ç‰ˆæœ¬ (å¯èƒ½å¤±æ•—)
        function normalizeName_Old(str) {
            return str.replace(/[ \t\r\n\.\-_\(\)ï¼ˆï¼‰]+/g, "").trim().toLowerCase();
        }

        // âœ… æ”¹è‰¯ç‰ˆæœ¬ (åŠ å…¥ Unicode Normalization)
        function normalizeName_New(str) {
            if (!str) return "";
            // NFKC å¯ä»¥æŠŠå…¨å½¢è½‰åŠå½¢ï¼ŒæŠŠç‰¹æ®Šçš„ç©ºç™½è½‰æˆæ™®é€šç©ºç™½
            return str.normalize('NFKC').replace(/[ \t\r\n\.\-_\(\)ï¼ˆï¼‰]+/g, "").trim().toLowerCase();
        }

        // === 3. åŸ·è¡Œæ¸¬è©¦ ===
        
        // è§£æç¾¤çµ„
        const parsedGroups = mockGroups.map(g => {
            const match = g.displayName.match(/^([A-Z0-9]+)[\.\-_\s]+(.+)$/);
            if (match) {
                return { 
                    original: g.displayName,
                    code: match[1], 
                    name: match[2].trim(),
                    cleanOld: normalizeName_Old(match[2]),
                    cleanNew: normalizeName_New(match[2])
                };
            }
            return null;
        }).filter(g => g);

        const tbody = document.getElementById("result-body");

        mockUsers.forEach(u => {
            const row = document.createElement("tr");
            
            // ä½¿ç”¨æ–°èˆŠå…©ç¨®æ–¹æ³•æ¸¬è©¦
            const userCleanOld = normalizeName_Old(u.department);
            const userCleanNew = normalizeName_New(u.department);
            
            // å˜—è©¦å°‹æ‰¾åŒ¹é…
            const matchOld = parsedGroups.find(g => g.cleanOld === userCleanOld || g.cleanOld.includes(userCleanOld) || userCleanOld.includes(g.cleanOld));
            const matchNew = parsedGroups.find(g => g.cleanNew === userCleanNew || g.cleanNew.includes(userCleanNew) || userCleanNew.includes(g.cleanNew));

            let status = "";
            let reason = "";

            if (matchNew) {
                status = `<span class="success">æˆåŠŸ (æ–°é‚è¼¯)</span>`;
                if (!matchOld) {
                    reason = "èˆŠé‚è¼¯å¤±æ•—ï¼Œæ–°é‚è¼¯æˆåŠŸï¼å¯èƒ½æ˜¯éš±è—å­—å…ƒæˆ–å…¨å½¢ç¬¦è™Ÿå•é¡Œã€‚";
                } else {
                    reason = "æ–°èˆŠé‚è¼¯éƒ½æˆåŠŸã€‚";
                }
            } else {
                status = `<span class="fail">å¤±æ•—</span>`;
                reason = "å®Œå…¨ç„¡æ³•åŒ¹é…ï¼Œè«‹æª¢æŸ¥æ˜¯å¦å­—å…ƒæ ¹æœ¬ä¸åŒ (ä¾‹å¦‚ 'å°' vs 'è‡º')ã€‚";
            }

            // é¡¯ç¤ºæœ€æ¥è¿‘çš„ç¾¤çµ„è³‡è¨Š
            const targetGroup = matchNew || matchOld || parsedGroups[0]; // é è¨­é¡¯ç¤ºç¬¬ä¸€å€‹ç•¶åƒè€ƒ

            row.innerHTML = `
                <td>${u.department}</td>
                <td>
                    Old: <code>${escapeHtml(userCleanOld)}</code><br>
                    New: <code>${escapeHtml(userCleanNew)}</code>
                </td>
                <td>
                    Group: ${targetGroup ? targetGroup.name : 'ç„¡'}<br>
                    Clean: <code>${targetGroup ? targetGroup.cleanNew : ''}</code>
                </td>
                <td>${status}</td>
                <td>${reason}</td>
            `;
            tbody.appendChild(row);
        });

        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>